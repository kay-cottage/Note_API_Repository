<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>增量代码编辑器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Consolas', 'Monaco', monospace;
            background: #1a1a1a;
            color: #e0e0e0;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .left-panel {
            width: 40%;
            background: #2d2d2d;
            border-right: 1px solid #444;
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease;
        }

        .left-panel.collapsed {
            width: 0;
            overflow: hidden;
        }

        .panel-header {
            background: #333;
            padding: 10px;
            border-bottom: 1px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .settings-btn {
            background: #ff9800;
            border: none;
            color: white;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 3px;
            margin-right: 5px;
        }

        .settings-btn:hover {
            background: #f57c00;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: #2d2d2d;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #444;
            border-radius: 8px;
            width: 500px;
            color: #e0e0e0;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #fff;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #4CAF50;
            font-weight: bold;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            background: #1e1e1e;
            border: 1px solid #444;
            border-radius: 4px;
            color: #e0e0e0;
            font-family: inherit;
        }

        .save-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
        }

        .save-btn:hover {
            background: #45a049;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-connected {
            background: #4CAF50;
        }

        .status-disconnected {
            background: #f44336;
        }

        .toggle-btn {
            background: #555;
            border: none;
            color: #e0e0e0;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 3px;
        }

        .toggle-btn:hover {
            background: #666;
        }

        .input-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 10px;
        }

        .section-title {
            color: #4CAF50;
            font-size: 14px;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .code-input {
            flex: 1;
            background: #1e1e1e;
            border: 1px solid #444;
            color: #e0e0e0;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            padding: 10px;
            resize: none;
            border-radius: 4px;
            line-height: 1.4;
        }

        .user-request {
            height: 120px;
            margin-top: 10px;
            background: #1e1e1e;
            border: 1px solid #444;
            color: #e0e0e0;
            padding: 10px;
            border-radius: 4px;
            font-family: inherit;
            resize: none;
        }

        .execute-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 20px;
            margin-top: 10px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 16px;
            font-weight: bold;
        }

        .execute-btn:hover {
            background: #45a049;
        }

        .execute-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .right-panel {
            flex: 1;
            background: #2d2d2d;
            display: flex;
            flex-direction: column;
        }

        .version-selector {
            background: #333;
            padding: 10px;
            border-bottom: 1px solid #444;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .version-select {
            background: #555;
            border: 1px solid #666;
            color: #e0e0e0;
            padding: 5px 10px;
            border-radius: 3px;
        }

        .copy-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 8px 15px;
            cursor: pointer;
            border-radius: 4px;
            margin-left: auto;
        }

        .copy-btn:hover {
            background: #1976D2;
        }

        .output-section {
            flex: 1;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }

        .code-output {
            flex: 1;
            background: #1e1e1e;
            border: 1px solid #444;
            color: #e0e0e0;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            padding: 10px;
            resize: none;
            border-radius: 4px;
            line-height: 1.4;
        }

        .expand-btn {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            background: #555;
            border: none;
            color: #e0e0e0;
            padding: 20px 5px;
            cursor: pointer;
            border-radius: 0 3px 3px 0;
            z-index: 1000;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #4CAF50;
        }

        .error {
            background: #f44336;
            color: white;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .line-numbers {
            background: #333;
            padding: 10px 5px;
            border-right: 1px solid #444;
            font-size: 12px;
            color: #888;
            text-align: right;
            min-width: 40px;
            white-space: pre-line;
            font-family: 'Consolas', 'Monaco', monospace;
            line-height: 1.4;
        }

        .code-container {
            display: flex;
            flex: 1;
        }

        .numbered-code {
            flex: 1;
            background: #1e1e1e;
            border: 1px solid #444;
            color: #e0e0e0;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            padding: 10px;
            resize: none;
            border-radius: 0 4px 4px 0;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="left-panel" id="leftPanel">
            <div class="panel-header">
                <h3>
                    <span class="status-indicator" id="statusIndicator"></span>
                    代码编辑器
                </h3>
                <div>
                    <button class="settings-btn" onclick="openSettings()">设置</button>
                    <button class="toggle-btn" onclick="togglePanel()">收起</button>
                </div>
            </div>
            <div class="input-section">
                <div class="section-title">原始代码输入</div>
                <textarea class="code-input" id="codeInput" placeholder="在此输入您的代码..."></textarea>
                
                <div class="section-title" style="margin-top: 15px;">修改需求</div>
                <textarea class="user-request" id="userRequest" placeholder="描述您希望对代码进行的修改..."></textarea>
                
                <button class="execute-btn" onclick="executeEdit()">执行编辑</button>
            </div>
        </div>

        <button class="expand-btn" id="expandBtn" onclick="togglePanel()" style="display: none;">展开</button>

        <div class="right-panel">
            <div class="version-selector">
                <label>版本选择：</label>
                <select class="version-select" id="versionSelect" onchange="loadVersion()">
                    <option value="0">当前版本</option>
                </select>
                <button class="copy-btn" onclick="copyToClipboard()">复制代码</button>
            </div>
            <div class="output-section">
                <div class="section-title">编辑结果</div>
                <div class="code-container">
                    <div class="line-numbers" id="lineNumbers"></div>
                    <textarea class="numbered-code" id="codeOutput" placeholder="编辑后的代码将显示在这里..."></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- 设置模态框 -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>API 设置</h3>
                <span class="close" onclick="closeSettings()">&times;</span>
            </div>
            <div class="form-group">
                <label for="apiKey">OpenAI API Key:</label>
                <input type="password" id="apiKey" placeholder="请输入您的OpenAI API Key">
            </div>
            <div class="form-group">
                <label for="apiModel">模型选择:</label>
                <select id="apiModel">
                    <option value="gpt-4o-mini">GPT-4O-Mini</option>
                    <option value="gpt-4o">GPT-4O</option>
                    <option value="gpt-4">GPT-4</option>
                    <option value="gpt-3.5-turbo">GPT-3.5-Turbo</option>
                </select>
            </div>
            <div class="form-group">
                <label for="apiBase">API Base URL (可选):</label>
                <input type="text" id="apiBase" placeholder="https://api.openai.com/v1" value="https://api.openai.com/v1">
            </div>
            <button class="save-btn" onclick="saveSettings()">保存设置</button>
        </div>
    </div>

    <script>
        // 全局变量
        let codeHistory = [];
        let currentVersion = 0;
        let isExecuting = false;
        let apiSettings = {
            apiKey: '',
            model: 'gpt-4o-mini',
            baseURL: 'https://api.openai.com/v1'
        };

        // 初始化设置
        function initializeSettings() {
            const savedSettings = localStorage.getItem('apiSettings');
            if (savedSettings) {
                apiSettings = {...apiSettings, ...JSON.parse(savedSettings)};
                document.getElementById('apiKey').value = apiSettings.apiKey;
                document.getElementById('apiModel').value = apiSettings.model;
                document.getElementById('apiBase').value = apiSettings.baseURL;
            }
            updateConnectionStatus();
        }

        // 更新连接状态
        function updateConnectionStatus() {
            const indicator = document.getElementById('statusIndicator');
            if (apiSettings.apiKey) {
                indicator.className = 'status-indicator status-connected';
                indicator.title = '已配置 API Key';
            } else {
                indicator.className = 'status-indicator status-disconnected';
                indicator.title = '未配置 API Key';
            }
        }

        // 打开设置
        function openSettings() {
            document.getElementById('settingsModal').style.display = 'block';
        }

        // 关闭设置
        function closeSettings() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        // 保存设置
        function saveSettings() {
            apiSettings.apiKey = document.getElementById('apiKey').value;
            apiSettings.model = document.getElementById('apiModel').value;
            apiSettings.baseURL = document.getElementById('apiBase').value;
            
            localStorage.setItem('apiSettings', JSON.stringify(apiSettings));
            updateConnectionStatus();
            closeSettings();
            alert('设置已保存！');
        }

        // PatchApplier 类的 JavaScript 实现
        class PatchApplier {
            constructor(originalMeta) {
                this.lines = originalMeta.map(item => ({...item}));
            }

            apply(operations) {
                for (const op of operations) {
                    try {
                        const opType = op.op;
                        switch (opType) {
                            case 'delete_line':
                                this._deleteBlock(op.line, op.end || op.line);
                                break;
                            case 'delete_block':
                                this._deleteBlock(op.start, op.end);
                                break;
                            case 'replace_line':
                                this._replaceLine(op.line, op.content);
                                break;
                            case 'insert_line':
                                this._insertBlock(op.line, [{num: null, text: op.content}]);
                                break;
                            case 'insert_block':
                                const newItems = op.content.map(ln => ({num: null, text: ln}));
                                this._insertBlock(op.line, newItems);
                                break;
                            case 'edit_block':
                                const newEditItems = op.content.map(ln => ({num: null, text: ln}));
                                this._editBlock(op.start, op.end, newEditItems);
                                break;
                            default:
                                throw new Error(`Unknown operation: ${opType}`);
                        }
                        console.log(`Successfully applied operation:`, op);
                    } catch (e) {
                        console.error(`Failed to apply operation ${JSON.stringify(op)}: ${e.message}`);
                    }
                }
                return this.lines;
            }

            _resolveIndex(origLine) {
                for (let idx = 0; idx < this.lines.length; idx++) {
                    if (this.lines[idx].num === origLine) {
                        return idx;
                    }
                }
                throw new Error(`Original line ${origLine} not found in current buffer`);
            }

            _deleteBlock(start, end) {
                const idxS = this._resolveIndex(start);
                const idxE = this._resolveIndex(end);
                this.lines.splice(idxS, idxE - idxS + 1);
            }

            _replaceLine(line, content) {
                const idx = this._resolveIndex(line);
                this.lines[idx].text = content;
            }

            _insertBlock(line, newMeta) {
                const idx = this._resolveIndex(line);
                for (let i = 0; i < newMeta.length; i++) {
                    this.lines.splice(idx + 1 + i, 0, newMeta[i]);
                }
            }

            _editBlock(start, end, newMeta) {
                const idxS = this._resolveIndex(start);
                const idxE = this._resolveIndex(end);
                this.lines.splice(idxS, idxE - idxS + 1, ...newMeta);
            }
        }

        // 读取行元数据
        function readLinesWithMeta(code) {
            const lines = code.split('\n');
            const meta = [];
            for (let i = 0; i < lines.length; i++) {
                meta.push({num: i + 1, text: lines[i]});
            }
            return meta;
        }

        // 真实的 GPT API 调用
        async function generatePatchWithGPT(userRequest, numberedCodeMeta) {
            if (!apiSettings.apiKey) {
                throw new Error('请先在设置中配置 OpenAI API Key');
            }

            // 构造目标代码字符串，保留行号元信息
            const codeLines = numberedCodeMeta.map(item => `${item.num}: ${item.text}`);
            const protocol = `你是增量编辑 Patch 应用器助手，接收三部分输入，返回纯 JSON 数组，不带任何额外文字标识：
你应该仔细分析根据用户需求修改代码，而不是机械地给出编辑指令！你需要严谨考虑每一步指令操作带来的影响，例如某处的改动是否需要连带考虑其他位置的代码也进行增删改操作等等

用户需求（描述要修改的内容）
目标代码（保留行号）
指令协议：
{"op":"delete_line", "line":L} 删除第 L 行
{"op":"delete_block", "start":S, "end":E} 删除第 S 行至第 E 行
{"op":"replace_line","line":L, "content":"文本"} 替换第 L 行
{"op":"insert_line","line":L, "content":"文本"} 在第 L 行之后插入一行
{"op":"insert_block","line":L, "content":["行1","行2"]} 在第 L 行之后插入多行
{"op":"edit_block","start":S, "end":E, "content":["行1","行2"]} 用多行替换第 S 到 E 行`;

            const prompt = `${protocol}

用户需求：${userRequest}

目标代码：
${codeLines.join('\n')}

请严格按照以上格式直接输出 JSON 数组。输出的例子demo如下:
{"ops":[{"op": "delete_block", "start": 8, "end": 11},{"op": "delete_block", "start": 2, "end": 3}]}`;

            const requestBody = {
                model: apiSettings.model,
                messages: [
                    {
                        role: 'user',
                        content: prompt
                    }
                ],
                response_format: { type: "json_object" },
                temperature: 0
            };

            try {
                const response = await fetch(`${apiSettings.baseURL}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiSettings.apiKey}`
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API Error: ${response.status} - ${errorData.error?.message || '未知错误'}`);
                }

                const data = await response.json();
                const text = data.choices[0].message.content.trim();
                
                try {
                    const result = JSON.parse(text);
                    const ops = result.ops;
                    if (!Array.isArray(ops)) {
                        throw new Error('GPT 返回内容不是 JSON 数组');
                    }
                    return ops;
                } catch (jsonError) {
                    throw new Error(`解析 GPT 输出失败: ${jsonError.message}\n输出: ${text}`);
                }
            } catch (error) {
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    throw new Error('网络连接失败，请检查网络连接或API地址');
                }
                throw error;
            }
        }

        // 执行编辑
        async function executeEdit() {
            if (isExecuting) return;
            
            if (!apiSettings.apiKey) {
                alert('请先在设置中配置 OpenAI API Key');
                return;
            }
            
            const codeInput = document.getElementById('codeInput').value;
            const userRequest = document.getElementById('userRequest').value;
            
            if (!codeInput.trim() || !userRequest.trim()) {
                alert('请输入代码和修改需求');
                return;
            }

            isExecuting = true;
            const executeBtn = document.querySelector('.execute-btn');
            executeBtn.disabled = true;
            executeBtn.textContent = '正在调用GPT...';

            try {
                const meta = readLinesWithMeta(codeInput);
                const operations = await generatePatchWithGPT(userRequest, meta);
                
                executeBtn.textContent = '正在应用补丁...';
                
                const applier = new PatchApplier(meta);
                const patchedMeta = applier.apply(operations);
                
                const resultCode = patchedMeta.map(item => item.text).join('\n');
                
                // 保存到历史记录
                codeHistory.push({
                    input: codeInput,
                    request: userRequest,
                    output: resultCode,
                    operations: operations,
                    timestamp: new Date().toLocaleString()
                });
                
                // 更新版本选择器
                updateVersionSelector();
                
                // 显示结果
                document.getElementById('codeOutput').value = resultCode;
                updateLineNumbers(resultCode);
                
                // 设置为最新版本
                currentVersion = codeHistory.length - 1;
                document.getElementById('versionSelect').value = currentVersion;
                
                // 显示成功消息
                executeBtn.textContent = '编辑成功！';
                setTimeout(() => {
                    executeBtn.textContent = '执行编辑';
                }, 2000);
                
            } catch (error) {
                console.error('编辑失败:', error);
                let errorMessage = '编辑失败: ' + error.message;
                if (error.message.includes('API Error: 401')) {
                    errorMessage = 'API Key 无效，请检查设置中的 API Key';
                } else if (error.message.includes('API Error: 429')) {
                    errorMessage = 'API 请求过于频繁，请稍后重试';
                } else if (error.message.includes('API Error: 500')) {
                    errorMessage = 'OpenAI 服务器错误，请稍后重试';
                }
                alert(errorMessage);
                executeBtn.textContent = '执行编辑';
            } finally {
                isExecuting = false;
                executeBtn.disabled = false;
            }
        }

        // 更新版本选择器
        function updateVersionSelector() {
            const select = document.getElementById('versionSelect');
            select.innerHTML = '<option value="0">当前版本</option>';
            
            for (let i = 0; i < codeHistory.length; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `版本 ${i + 1} (${codeHistory[i].timestamp})`;
                select.appendChild(option);
            }
        }

        // 加载版本
        function loadVersion() {
            const versionIndex = parseInt(document.getElementById('versionSelect').value);
            if (versionIndex === 0) {
                // 当前版本
                document.getElementById('codeOutput').value = '';
                document.getElementById('lineNumbers').textContent = '';
            } else {
                const version = codeHistory[versionIndex];
                document.getElementById('codeOutput').value = version.output;
                updateLineNumbers(version.output);
                
                // 同时显示当时的输入和需求
                document.getElementById('codeInput').value = version.input;
                document.getElementById('userRequest').value = version.request;
            }
            currentVersion = versionIndex;
        }

        // 更新行号
        function updateLineNumbers(code) {
            const lines = code.split('\n');
            const lineNumbers = lines.map((_, i) => i + 1).join('\n');
            document.getElementById('lineNumbers').textContent = lineNumbers;
        }

        // 复制到剪贴板
        function copyToClipboard() {
            const codeOutput = document.getElementById('codeOutput');
            codeOutput.select();
            document.execCommand('copy');
            
            const btn = document.querySelector('.copy-btn');
            const originalText = btn.textContent;
            btn.textContent = '已复制!';
            setTimeout(() => {
                btn.textContent = originalText;
            }, 1000);
        }

        // 切换面板
        function togglePanel() {
            const leftPanel = document.getElementById('leftPanel');
            const expandBtn = document.getElementById('expandBtn');
            
            if (leftPanel.classList.contains('collapsed')) {
                leftPanel.classList.remove('collapsed');
                expandBtn.style.display = 'none';
            } else {
                leftPanel.classList.add('collapsed');
                expandBtn.style.display = 'block';
            }
        }

        // 监听输出区域的变化，自动更新行号
        document.getElementById('codeOutput').addEventListener('input', function() {
            updateLineNumbers(this.value);
        });

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化设置
            initializeSettings();
            
            // 设置示例代码
            document.getElementById('codeInput').value = `def hello_world():
    print("Hello, World!")
    return "success"

def main():
    result = hello_world()
    print(f"Result: {result}")

if __name__ == "__main__":
    main()`;
            
            // 点击模态框外部关闭
            window.onclick = function(event) {
                const modal = document.getElementById('settingsModal');
                if (event.target === modal) {
                    closeSettings();
                }
            };
        });
    </script>
</body>
</html>
