<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>增量代码编辑器</title>

    <!-- 样式文件 (CSS) 仍然放在头部，以便页面能尽快渲染出样式 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/material-darker.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        :root {
            --bg-color: #1a1a1d;
            --panel-bg-color: #2c2c34;
            --editor-bg-color: #212121;
            --border-color: #444;
            --text-color: #e0e0e0;
            --primary-color: #4a90e2;
            --primary-hover-color: #5aa1f2;
            --secondary-color: #777;
            --font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --border-radius: 8px;
            --transition-speed: 0.3s;
        }

        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- Header & Settings --- */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 20px;
            background-color: var(--panel-bg-color);
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 1.2em;
            margin: 0;
        }
        
        #settings-toggle {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.5em;
            cursor: pointer;
            transition: transform var(--transition-speed);
        }
        #settings-toggle:hover {
            transform: scale(1.1) rotate(15deg);
        }

        #settings-panel {
            background-color: #3a3a42;
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: none; /* Initially hidden */
            flex-shrink: 0;
            animation: slide-down 0.4s ease-out;
        }
        
        @keyframes slide-down {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 120px 1fr;
            gap: 15px;
            align-items: center;
        }

        .settings-grid label {
            font-weight: bold;
        }
        .settings-grid input, .settings-grid select {
            width: 100%;
            padding: 8px;
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            color: var(--text-color);
            box-sizing: border-box;
        }

        /* --- Main Container --- */
        #container {
            display: flex;
            flex-grow: 1;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        #left-panel {
            width: 50%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background-color: var(--panel-bg-color);
            transition: width var(--transition-speed), min-width var(--transition-speed);
            min-width: 400px;
            position: relative;
        }

        #left-panel.collapsed {
            width: 40px;
            min-width: 40px;
            overflow: hidden;
        }
        
        #panel-toggle {
            position: absolute;
            top: 50%;
            left: 5px;
            transform: translateY(-50%);
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            z-index: 100;
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
        
        #left-panel.collapsed #panel-toggle {
            display: flex;
        }

        #left-panel-content {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
        }

        #left-panel.collapsed #left-panel-content {
            display: none;
        }

        #resizer {
            width: 5px;
            background-color: var(--border-color);
            cursor: col-resize;
            flex-shrink: 0;
            transition: background-color var(--transition-speed);
        }
        #resizer:hover {
            background-color: var(--primary-color);
        }

        #right-panel {
            flex-grow: 1;
            height: 100%;
            display: flex;
            flex-direction: column;
            background-color: var(--panel-bg-color);
        }

        .editor-container {
            flex-grow: 1;
            position: relative;
            overflow: hidden;
        }

        .CodeMirror {
            height: 100% !important;
            font-size: 14px;
            line-height: 1.5;
            background: var(--editor-bg-color);
            border-radius: var(--border-radius); /* Added rounded corners */
        }

        /* --- Left Panel Bottom (User Prompt) --- */
        #user-prompt-container {
            padding: 15px;
            border-top: 1px solid var(--border-color);
            background-color: #35353d;
            flex-shrink: 0;
        }
        
        #user-prompt {
            width: 100%;
            height: 80px;
            background-color: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 10px;
            box-sizing: border-box;
            resize: vertical;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        #generate-btn {
            display: block;
            width: 100%;
            padding: 12px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-size: 16px;
            cursor: pointer;
            transition: background-color var(--transition-speed);
        }
        #generate-btn:hover:not(:disabled) {
            background-color: var(--primary-hover-color);
        }
        #generate-btn:disabled {
            background-color: var(--secondary-color);
            cursor: not-allowed;
        }
        #generate-btn .fas {
            margin-right: 8px;
        }

        /* --- Right Panel Header --- */
        #right-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px;
            background-color: #35353d;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        #version-history {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        #version-history span {
            font-weight: bold;
        }
        
        .version-btn {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
            transition: background-color var(--transition-speed);
        }
        
        .version-btn.active, .version-btn:hover {
            background-color: var(--primary-color);
        }
        
        #copy-btn {
            background: none;
            border: 1px solid var(--secondary-color);
            color: var(--text-color);
            padding: 8px 12px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all var(--transition-speed);
        }
        #copy-btn:hover {
            background-color: var(--secondary-color);
            color: white;
        }

        #main-panel-toggle {
            position: absolute;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
            cursor: pointer;
            background: var(--primary-color);
            color: white;
            width: 20px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-top-right-radius: var(--border-radius);
            border-bottom-right-radius: var(--border-radius);
            z-index: 50;
            transition: opacity var(--transition-speed);
        }

        #left-panel.collapsed ~ #main-panel-toggle {
            opacity: 0;
            pointer-events: none;
        }

        /* Custom Message Box Styles */
        .message-box-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .message-box {
            background-color: var(--panel-bg-color);
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .message-box p {
            margin-bottom: 20px;
            font-size: 1.1em;
            color: var(--text-color);
        }

        .message-box button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1em;
            transition: background-color var(--transition-speed);
        }

        .message-box button:hover {
            background-color: var(--primary-hover-color);
        }
    </style>
</head>
<body>

    <header class="header">
        <h1><i class="fa-solid fa-code-branch"></i> 增量代码编辑器</h1>
        <button id="settings-toggle" title="基础设置">
            <i class="fa-solid fa-gear"></i>
        </button>
    </header>

    <div id="settings-panel">
        <div class="settings-grid">
            <label for="model-select">选择模型:</label>
            <select id="model-select">
                <option value="gpt-4o">GPT-4o</option>
                <option value="deepseek-coder">DeepSeek-Coder</option>
                <option value="gemini-1.5-pro">Gemini-1.5-Pro</option>
                <option value="custom">自定义</option>
            </select>

            <label for="api-url">API URL:</label>
            <input type="text" id="api-url" placeholder="例如: https://api.openai.com/v1/chat/completions">

            <label for="api-key">API Key:</label>
            <input type="password" id="api-key" placeholder="在此输入您的 API Key">
        </div>
    </div>

    <div id="container">
        <div id="left-panel">
             <div id="panel-toggle" title="展开">
                <i class="fa-solid fa-angles-right"></i>
            </div>
            <div id="left-panel-content">
                <div class="editor-container">
                    <textarea id="left-editor"></textarea>
                </div>
                <div id="user-prompt-container">
                    <textarea id="user-prompt" placeholder="在此输入您的代码更改要求..."></textarea>
                    <button id="generate-btn">
                        <i class="fa-solid fa-wand-magic-sparkles"></i>
                        生成修改
                    </button>
                </div>
            </div>
        </div>

        <div id="resizer"></div>

        <div id="right-panel">
            <div id="right-panel-header">
                <div id="version-history">
                    <span>历史版本:</span>
                    <!-- Version buttons will be injected here -->
                </div>
                <button id="copy-btn"><i class="fa-regular fa-copy"></i> 复制</button>
            </div>
            <div class="editor-container">
                <textarea id="right-editor"></textarea>
            </div>
        </div>
        <div id="main-panel-toggle" title="收起">
            <i class="fa-solid fa-angles-left"></i>
        </div>
    </div>

    <!-- JAVASCRIPT LIBRARIES: Moved to the end of the body and outside window.onload -->
    <!-- This ensures the HTML is fully parsed and these scripts are executed before your app logic. -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/edit/closebrackets.min.js"></script>

    <!-- YOUR APPLICATION'S SCRIPT: This runs last, after all libraries are loaded. -->
    <script>
        // We wrap the entire script in a DOMContentLoaded listener to be extra safe.
        // This ensures the DOM is fully ready before we try to manipulate it.
        window.onload = function() {
            // --- Custom Message Box Implementation ---
            function showMessageBox(message) {
                const overlay = document.createElement('div');
                overlay.className = 'message-box-overlay';

                const messageBox = document.createElement('div');
                messageBox.className = 'message-box';

                const messageParagraph = document.createElement('p');
                messageParagraph.textContent = message;

                const closeButton = document.createElement('button');
                closeButton.textContent = '确定';
                closeButton.onclick = () => {
                    document.body.removeChild(overlay);
                };

                messageBox.appendChild(messageParagraph);
                messageBox.appendChild(closeButton);
                overlay.appendChild(messageBox);
                document.body.appendChild(overlay);
            }

            // --- CORE LOGIC: Reimplementation of the Python Script ---

            /**
             * The JavaScript equivalent of the AnchorPatchApplier class.
             * It manipulates an array of strings (code lines) based on operations.
             */
            class JsAnchorPatchApplier {
                constructor(lines) {
                    this.lines = [...lines];
                }

                _find(pattern, start = 0) {
                    try {
                        const rx = new RegExp(pattern);
                        for (let i = start; i < this.lines.length; i++) {
                            if (rx.test(this.lines[i])) {
                                return i;
                            }
                        }
                        throw new Error(`锚点(Anchor)正则 '${pattern}' 未找到`);
                    } catch (e) {
                         throw new Error(`无效的正则表达式 '${pattern}': ${e.message}`);
                    }
                }

                insert_at_anchor(anchor, newLines, offset = 0) {
                    const pos = this._find(anchor) + offset;
                    this.lines.splice(pos, 0, ...newLines);
                }

                insert_after(anchor, newLines, offset = 0) {
                    const pos = this._find(anchor) + 1 + offset;
                    this.lines.splice(pos, 0, ...newLines);
                }

                insert_before(anchor, newLines, offset = 0) {
                    const pos = this._find(anchor) + offset;
                    this.lines.splice(pos, 0, ...newLines);
                }

                replace_line(anchor, content, offset = 0) {
                    const idx = this._find(anchor) + offset;
                    if (idx < 0 || idx >= this.lines.length) {
                        throw new Error(`根据锚点 '${anchor}' 得到的索引 ${idx} 无效`);
                    }
                    this.lines[idx] = content;
                }

                delete_block(anchor, tail_anchor = null, count = null) {
                    const s = this._find(anchor);
                    let e;
                    if (tail_anchor) {
                        e = this._find(tail_anchor, s + 1) + 1;
                    } else if (count !== null) {
                        e = s + count;
                    } else {
                        throw new Error("delete_block 操作需要 tail_anchor 或 count 参数");
                    }
                    this.lines.splice(s, e - s);
                }

                replace_block(anchor, newLines, tail_anchor) {
                    const s = this._find(anchor);
                    const e = this._find(tail_anchor, s + 1) + 1;
                    this.lines.splice(s, e - s, ...newLines);
                }

                apply_ops(ops) {
                    ops.forEach(op => {
                        const type = op.op;
                        switch (type) {
                            case 'insert_at_anchor':
                                this.insert_at_anchor(op.anchor, op.new, op.offset);
                                break;
                            case 'insert_after':
                                this.insert_after(op.anchor, op.new, op.offset);
                                break;
                            case 'insert_before':
                                this.insert_before(op.anchor, op.new, op.offset);
                                break;
                            case 'replace_line':
                                let content = op.content;
                                if (content === undefined && 'new' in op) {
                                    const newValue = op.new;
                                    if (Array.isArray(newValue) && newValue.length > 0) {
                                        content = newValue[0];
                                    } else if (typeof newValue === 'string') {
                                        content = newValue;
                                    }
                                }
                                if (content === undefined) {
                                    throw new Error("replace_line 操作缺少 'content' 或 'new' 字段");
                                }
                                this.replace_line(op.anchor, content, op.offset);
                                break;
                            case 'delete_block':
                                this.delete_block(op.anchor, op.tail_anchor, op.count);
                                break;
                            case 'replace_block':
                                this.replace_block(op.anchor, op.new, op.tail_anchor);
                                break;
                            default:
                                throw new Error(`未知的操作类型: ${type}`);
                        }
                    });
                    return this.lines;
                }
            }
            
            const ANCHOR_PROTOCOL = `你是增量编辑 Patch 应用器助手，只返回严格 JSON 数组或字典，不要任何解释。
禁止使用行号字段(line/start/end)，所有定位仅靠 anchor 正则。
支持 ops：insert_at_anchor, insert_after, insert_before, replace_line, delete_block, replace_block。
- insert_at_anchor: 在anchor位置插入内容（替换anchor行）
- insert_after: 在anchor之后插入内容
- insert_before: 在anchor之前插入内容
- replace_line: 替换anchor指定的行
- delete_block: 删除从anchor开始的代码块
- replace_block: 替换从anchor到tail_anchor的代码块`;

            /**
             * Generates a patch by calling the specified AI model API.
             */
            async function generatePatch(userRequest, codeLines, model, apiUrl, apiKey) {
                const prompt = `${ANCHOR_PROTOCOL}\n用户需求：${userRequest}\n\n当前代码：\n${codeLines.join('\n')}\n\n直接输出 JSON 数组或嵌套字典 {'operations': [...]}。示例：\n[{"op":"insert_after","anchor":"^import sys$","new":["import logging"]}]`;

                if (!apiUrl) {
                    throw new Error("API URL 未设置。");
                }

                const isGemini = apiUrl.includes("generativelanguage.googleapis.com");
                let headers = {
                    'Content-Type': 'application/json',
                };
                let body;

                if (isGemini) {
                    // For Gemini, the API key is typically appended to the URL as a query parameter
                    // or handled by the environment (like Canvas). We won't send it in the header.
                    // The URL should already contain `?key=` if it's from `apiUrls` for Gemini.
                    body = JSON.stringify({
                        contents: [{
                            parts: [{ text: prompt }]
                        }],
                        generationConfig: {
                            responseMimeType: "application/json",
                        }
                    });
                } else { // OpenAI-compatible (GPT-4o, DeepSeek-Coder)
                    if (!apiKey) {
                        throw new Error("API Key 未设置。");
                    }
                    headers['Authorization'] = `Bearer ${apiKey}`;
                    body = JSON.stringify({
                        model: model,
                        messages: [{ role: 'user', content: prompt }],
                        temperature: 0,
                        response_format: { type: 'json_object' } 
                    });
                }

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: headers,
                    body: body
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`API 请求失败: ${response.status} ${response.statusText}\n${errorBody}`);
                }

                const data = await response.json();
                let rawContent;

                if(isGemini) {
                    // Gemini API response structure
                    if (data.candidates && data.candidates.length > 0 &&
                        data.candidates[0].content && data.candidates[0].content.parts &&
                        data.candidates[0].content.parts.length > 0) {
                        rawContent = data.candidates[0].content.parts[0].text;
                    } else {
                        throw new Error("Gemini API 返回的响应结构不符合预期。");
                    }
                } else { // OpenAI-compatible response structure
                    rawContent = data.choices[0].message.content.trim();
                }
                
                let parsedData;
                try {
                    parsedData = JSON.parse(rawContent);
                } catch (e) {
                    throw new Error(`无法解析模型的JSON输出: ${rawContent}. 错误: ${e.message}`);
                }
                
                const ops = parsedData.operations || parsedData;

                if (!Array.isArray(ops)) {
                    throw new Error('模型必须返回一个 JSON 数组或包含 "operations" 键的字典。');
                }
                return ops;
            }


            // --- UI SETUP & EVENT LISTENERS ---

            const leftTextArea = document.getElementById('left-editor');
            const rightTextArea = document.getElementById('right-editor');

            const commonEditorOptions = {
                lineNumbers: true,
                mode: 'python', // Default mode, can be changed dynamically
                theme: 'material-darker',
                autoCloseBrackets: true,
                indentUnit: 4,
            };

            const leftEditor = CodeMirror.fromTextArea(leftTextArea, {
                ...commonEditorOptions,
            });

            const rightEditor = CodeMirror.fromTextArea(rightTextArea, {
                ...commonEditorOptions,
                readOnly: true // Right editor is read-only for generated code
            });
            
            // Example initial code
            const initialCode = `from __future__ import annotations
import hashlib
import json
import shutil
import re
import os
from pathlib import Path
from typing import Any, Dict, List, Sequence

# 这是一个读取文件的辅助函数
def read_lines(file_path: str) -> List[str]:
    if not Path(file_path).is_file():
        raise FileNotFoundError(file_path)
    with open(file_path, 'r', encoding='utf-8') as fh:
        return [ln.rstrip("\\n") for ln in fh]

# 这是一个写文件的辅助函数
def write_lines(file_path: str, lines: Sequence[str]) -> None:
    with open(file_path, 'w', encoding='utf-8') as fh:
        for ln in lines:
            fh.write(ln + "\\n")`;
            
            leftEditor.setValue(initialCode);
            rightEditor.setValue("# 修改后的代码将显示在此处");

            // --- Version History ---
            let versionHistory = [];
            
            // Function to add the current right editor content to history and re-render buttons
            function updateAndRenderHistory(codeToSave) {
                // Only add to history if there's actual content
                if (codeToSave.trim() !== '' && codeToSave.trim() !== '# 修改后的代码将显示在此处') {
                    versionHistory.push(codeToSave);
                }
                renderVersionHistory();
            }

            // Function to render the version history buttons
            function renderVersionHistory() {
                const historyContainer = document.getElementById('version-history');
                historyContainer.innerHTML = '<span>历史版本:</span>'; // Clear existing buttons

                // Add buttons for previous versions
                versionHistory.forEach((versionCode, index) => {
                    const btn = document.createElement('button');
                    btn.className = 'version-btn';
                    btn.textContent = `v${index}`;
                    btn.onclick = () => {
                        rightEditor.setValue(versionCode);
                        // Deactivate all buttons and activate this one
                        document.querySelectorAll('.version-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                    };
                    historyContainer.prepend(btn); // Add to the beginning to show latest on the right
                });

                // Add button for the current state (always the latest generated or initial)
                const currentBtn = document.createElement('button');
                currentBtn.className = 'version-btn active'; // Always active by default
                currentBtn.textContent = `当前`;
                currentBtn.onclick = () => {
                    rightEditor.setValue(leftEditor.getValue()); // "Current" refers to the left editor's content
                    document.querySelectorAll('.version-btn').forEach(b => b.classList.remove('active'));
                    currentBtn.classList.add('active');
                };
                historyContainer.appendChild(currentBtn);
            }

            // --- Panel Resizing ---
            const resizer = document.getElementById('resizer');
            const leftPanel = document.getElementById('left-panel');
            
            let isResizing = false;
            resizer.addEventListener('mousedown', (e) => {
                isResizing = true;
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });

            function onMouseMove(e) {
                if (!isResizing) return;
                const containerRect = document.getElementById('container').getBoundingClientRect();
                let leftWidth = e.clientX - containerRect.left;
                // Ensure minimum width for both panels
                if (leftWidth < 300) leftWidth = 300; 
                if (leftWidth > containerRect.width - 300) leftWidth = containerRect.width - 300; 
                leftPanel.style.width = `${leftWidth}px`;
                // Refresh CodeMirror instances to adjust to new panel sizes
                leftEditor.refresh();
                rightEditor.refresh();
            }

            function onMouseUp() {
                isResizing = false;
                document.body.style.cursor = 'default';
                document.body.style.userSelect = 'auto';
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            }

            // --- Panel Toggling ---
            const mainPanelToggle = document.getElementById('main-panel-toggle');
            const leftPanelToggle = document.getElementById('panel-toggle');

            mainPanelToggle.addEventListener('click', () => {
                leftPanel.classList.add('collapsed');
                setTimeout(() => { // Refresh editors after collapse animation
                    leftEditor.refresh();
                    rightEditor.refresh();
                }, var_to_ms('--transition-speed')); // Convert CSS variable to milliseconds
            });

            leftPanelToggle.addEventListener('click', () => {
                leftPanel.classList.remove('collapsed');
                setTimeout(() => { // Refresh editors after expand animation
                    leftEditor.refresh();
                    rightEditor.refresh();
                }, var_to_ms('--transition-speed'));
            });

            // Helper to convert CSS variable to milliseconds
            function var_to_ms(cssVar) {
                const style = getComputedStyle(document.documentElement);
                const value = style.getPropertyValue(cssVar).trim();
                if (value.endsWith('s')) {
                    return parseFloat(value) * 1000;
                }
                return parseFloat(value);
            }

            // --- Settings Panel ---
            const settingsToggle = document.getElementById('settings-toggle');
            const settingsPanel = document.getElementById('settings-panel');
            const modelSelect = document.getElementById('model-select');
            const apiUrlInput = document.getElementById('api-url');
            const apiKeyInput = document.getElementById('api-key');
            
            // Define API URLs for different models.
            // For Gemini, the 'key=' parameter is left empty, as the Canvas environment will inject it.
            const apiUrls = {
                'gpt-4o': 'https://api.openai.com/v1/chat/completions',
                'deepseek-coder': 'https://api.deepseek.com/chat/completions',
                'gemini-1.5-pro': `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro-latest:generateContent?key=` // Key will be provided by Canvas runtime
            };

            settingsToggle.addEventListener('click', () => {
                const isHidden = settingsPanel.style.display === 'none' || settingsPanel.style.display === '';
                settingsPanel.style.display = isHidden ? 'block' : 'none';
            });
            
            // Update API URL when model selection changes
            modelSelect.addEventListener('change', () => {
                const selectedModel = modelSelect.value;
                if (apiUrls[selectedModel]) {
                    apiUrlInput.value = apiUrls[selectedModel];
                } else if (selectedModel === 'custom') {
                    apiUrlInput.value = ''; // Clear for custom
                }
                saveSettings();
            });

            // Save/Load settings from localStorage
            function saveSettings() {
                localStorage.setItem('codeEditor_model', modelSelect.value);
                localStorage.setItem('codeEditor_apiUrl', apiUrlInput.value);
                localStorage.setItem('codeEditor_apiKey', apiKeyInput.value); // Store API key for non-Gemini models
            }

            function loadSettings() {
                modelSelect.value = localStorage.getItem('codeEditor_model') || 'gpt-4o';
                apiKeyInput.value = localStorage.getItem('codeEditor_apiKey') || '';
                apiUrlInput.value = localStorage.getItem('codeEditor_apiUrl') || apiUrls[modelSelect.value];
            }
            
            apiUrlInput.addEventListener('input', saveSettings);
            apiKeyInput.addEventListener('input', saveSettings);
            
            loadSettings(); // Load settings on initial page load
            
            // --- Buttons ---
            const generateBtn = document.getElementById('generate-btn');
            const copyBtn = document.getElementById('copy-btn');
            
            generateBtn.addEventListener('click', async () => {
                const userRequest = document.getElementById('user-prompt').value;
                const originalCode = leftEditor.getValue();
                
                if (!userRequest || !originalCode) {
                    showMessageBox("请输入原始代码和您的修改要求。");
                    return;
                }
                
                generateBtn.disabled = true;
                generateBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> 处理中...';

                try {
                    const codeLines = originalCode.split('\n');
                    
                    // Save current right editor state to history BEFORE updating
                    updateAndRenderHistory(rightEditor.getValue());

                    const ops = await generatePatch(
                        userRequest,
                        codeLines,
                        modelSelect.value,
                        apiUrlInput.value,
                        apiKeyInput.value // Pass API key for non-Gemini models
                    );
                    
                    const applier = new JsAnchorPatchApplier(codeLines);
                    const newLines = applier.apply_ops(ops);
                    const newCode = newLines.join('\n');
                    
                    rightEditor.setValue(newCode);

                    // Re-render history to show the new "Current" state correctly
                    renderVersionHistory();

                } catch (error) {
                    console.error(error);
                    showMessageBox(`发生错误: ${error.message}`);
                    rightEditor.setValue(`# 错误: ${error.message}`);
                    // If there was an error, we should revert the history
                    versionHistory.pop(); // Remove the last (erroneous) entry
                    renderVersionHistory();
                } finally {
                    generateBtn.disabled = false;
                    generateBtn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i> 生成修改';
                }
            });
            
            copyBtn.addEventListener('click', () => {
                // Use document.execCommand('copy') for better compatibility in iframes
                const textArea = document.createElement('textarea');
                textArea.value = rightEditor.getValue();
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    const originalText = copyBtn.innerHTML;
                    copyBtn.innerHTML = '<i class="fa-solid fa-check"></i> 已复制!';
                    setTimeout(() => {
                        copyBtn.innerHTML = originalText;
                    }, 2000);
                } catch (err) {
                    console.error('无法复制到剪贴板:', err);
                    showMessageBox('复制失败，请手动复制。');
                }
                document.body.removeChild(textArea);
            });

            // Initial render of history (empty initially, or with a placeholder)
            renderVersionHistory();
        };

    </script>
</body>
</html>
