<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>AI 笔记批量整理工具</title>
    <style>
      :root {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
        --bg: #f4f6f9;
        --card: #fff;
        --primary: #0969da;
      }
      body { margin: 0; background: var(--bg); }
      .container { max-width: 960px; margin: auto; padding: 1rem; }
      h1 { font-size: 1.5rem; text-align: center; margin-bottom: 1.2rem; }
      form { display: grid; gap: .8rem; }
      label { display: flex; flex-direction: column; font-size: .9rem; }
      input, select, textarea, button {
        padding: .55rem .75rem; border: 1px solid #d0d7de; border-radius: .5rem;
        font-size: .9rem; line-height: 1.4;
      }
      input[type="checkbox"] { width: auto; margin-right: .5rem; }
      button {
        background: var(--primary); color: #fff; border: none; cursor: pointer;
        transition: background .15s ease-in-out;
      }
      button:hover { background: #0353c3; }
      .status { margin-top: 1rem; background: var(--card); border-radius: .75rem; padding: 1rem; max-height: 320px; overflow: auto; font-size: .8rem; }
      @media (prefers-color-scheme: dark) {
        :root { --bg: #0d1117; --card: #161b22; --primary: #2f81f7; }
        body { color: #c9d1d9; }
        input, select, textarea { background: #0d1117; color: #c9d1d9; border-color: #30363d; }
        button { background: var(--primary); }
        button:hover { background: #1d6cf2; }
        .status { background: #161b22; }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>AI 笔记批量整理工具</h1>
      <form id="config-form">
        <label>GitHub Token（需要 repo 权限）
          <input type="password" id="gh-token" required />
        </label>
        <label>GitHub 用户名
          <input type="text" id="gh-user" required />
        </label>
        <label>仓库名
          <input type="text" id="gh-repo" required />
        </label>
        <label>源目录（笔记原始 md 文件所在目录，如 notes/2025）
          <input type="text" id="source-dir" value="notes" required />
        </label>
        <label>目标目录（AI 整理结果输出目录，例如 notes_ai）
          <input type="text" id="target-dir" value="notes_ai" required />
        </label>
        <label>日志文件路径（存储已处理文件的列表）
          <input type="text" id="log-file" value="notes_ai/ai-edit-log.json" required />
        </label>
        <label>OpenAI API Key
          <input type="password" id="openai-key" required />
        </label>
        <label>模型
          <select id="openai-model">
            <option value="gpt-4o">gpt-4o</option>
            <option value="gpt-4o-mini">gpt-4o-mini</option>
            <option value="gpt-4-turbo">gpt-4-turbo</option>
            <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
          </select>
        </label>
        <label style="display:flex;align-items:center;">
          <input type="checkbox" id="remember"> 记住以上设置（仅保存在浏览器本地）
        </label>
        <button id="run-btn" type="submit">运行 AI 整理</button>
      </form>
      <div class="status" id="status"></div>
    </div>

    <script>
      /* ========== 日志工具 ========== */
      const statusBox = document.getElementById('status');
      const log = (msg, type = 'info') => {
        const el = document.createElement('div');
        el.textContent = `[${new Date().toLocaleString()}] ${msg}`;
        if (type === 'error') el.style.color = 'crimson';
        statusBox.prepend(el);
      };

      /* ========== localStorage 持久化 ========== */
      const fields = ['gh-token','gh-user','gh-repo','source-dir','target-dir','log-file','openai-key','openai-model'];
      (function loadSaved(){
        if(localStorage.getItem('ai-note-remember')==='true'){
          fields.forEach(id=>{
            const v=localStorage.getItem('ai-note-'+id);
            if(v!==null) document.getElementById(id).value=v;
          });
          document.getElementById('remember').checked=true;
        }
      })();
      function saveSettings(){
        if(document.getElementById('remember').checked){
          localStorage.setItem('ai-note-remember','true');
          fields.forEach(id=>localStorage.setItem('ai-note-'+id,document.getElementById(id).value));
        }else{
          localStorage.removeItem('ai-note-remember');
          fields.forEach(id=>localStorage.removeItem('ai-note-'+id));
        }
      }

      /* ========== GitHub API ========== */
      const ghRequest=(method,path,token,body)=>fetch(`https://api.github.com${path}`,{
        method,
        headers:{'Authorization':`Bearer ${token}`,'Accept':'application/vnd.github+json'},
        body:body?JSON.stringify(body):undefined
      }).then(async r=>{if(!r.ok){throw new Error(`GitHub ${r.status}`);}return r.json();});
      const listRepoFiles=async(u,r,d,t,a=[])=>{
        const res=await ghRequest('GET',`/repos/${u}/${r}/contents/${encodeURIComponent(d)}`,t);
        for(const i of res){i.type==='file'?a.push({path:i.path,sha:i.sha}):await listRepoFiles(u,r,i.path,t,a);}return a;};
      const getFileContent=async(u,r,p,t)=>{const res=await ghRequest('GET',`/repos/${u}/${r}/contents/${encodeURIComponent(p)}`,t);return{content:decodeURIComponent(escape(atob(res.content.replace(/\n/g,'')))),sha:res.sha};};
      const commitFile=async(u,r,p,t,c,m,s)=>ghRequest('PUT',`/repos/${u}/${r}/contents/${encodeURIComponent(p)}`,t,{message:m,content:btoa(unescape(encodeURIComponent(c))),committer:{name:'AI Bot',email:'ai@example.com'},sha:s});
      const loadLog=async(u,r,p,t)=>{try{const {content,sha}=await getFileContent(u,r,p,t);return{list:JSON.parse(content),sha};}catch(e){if(e.message.includes('404'))return{list:[],sha:undefined};throw e;}};

      /* ========== OpenAI meta 生成 ========== */
      async function openaiGenerateMeta(apiKey,model,markdown){
        const sys='你是一位 Markdown 日志索引器。\n任务：1) 找出所有##时间标题 2) 只输出对应meta块，不含正文。';
        const usr='以下 Markdown：\n```markdown\n'+markdown+'\n```';
        const res=await fetch('https://api.openai.com/v1/chat/completions',{method:'POST',headers:{'Authorization':`Bearer ${apiKey}`,'Content-Type':'application/json'},body:JSON.stringify({model,messages:[{role:'system',content:sys},{role:'user',content:usr}],temperature:0.2})});
        if(!res.ok)throw new Error('OpenAI '+res.status);return(await res.json()).choices[0].message.content;
      }

      const parseMetaList=txt=>{const map={},re=/标题:\s*(\d{4}\/\d{2}\/\d{2} \d{2}:\d{2}:\d{2})[\s\S]*?```yaml meta\n([\s\S]*?)```/g;let m;while((m=re.exec(txt))!==null){map[m[1]]=m[2].trim();}return map;};
      const insertMetaBlocks=(orig,map)=>orig.replace(/^## (\d{4}\/\d{2}\/\d{2} \d{2}:\d{2}:\d{2})$/gm,(m,ts)=>map[ts]?`${m}\n\`\`\`yaml meta\n${map[ts]}\n\`\`\``:m);

      /* ========== 表单提交 ========== */
      document.getElementById('config-form').addEventListener('submit',async e=>{
        e.preventDefault();saveSettings();
        const v=id=>document.getElementById(id).value.trim();
        const [kU,kR,sDir,tDir,logP,oaKey,mdl,ghT]=[v('gh-user'),v('gh-repo'),v('source-dir').replace(/^\/+|\/+$/g,''),v('target-dir').replace(/^\/+|\/+$/g,''),v('log-file'),v('openai-key'),v('openai-model'),v('gh-token')];
        try{
          log('读取文件列表…');
          const files=await listRepoFiles(kU,kR,sDir,ghT);
          log(`共有 ${files.length} 个文件`);
          const {list:done,sha:logSha}=await loadLog(kU,kR,logP,ghT);const doneSet=new Set(done.map(i=>i.path));
          for(const f of files.filter(f=>f.path.endsWith('.md')&&!doneSet.has(f.path))){
            try{
              log('处理 '+f.path);
              const {content}=await getFileContent(kU,kR,f.path,ghT);
              const metaTxt=await openaiGenerateMeta(oaKey,mdl,content);
              const finalMd=insertMetaBlocks(content,parseMetaList(metaTxt));
              const target=`${tDir}/${f.path.substring(sDir.length+1)}`;
              await commitFile(kU,kR,target,ghT,finalMd,'AI meta insert: '+f.path);
              done.push({path:f.path,editedAt:new Date().toISOString()});
              log('完成 '+f.path);
            }catch(err){log(err.message,'error');}
          }
          await commitFile(kU,kR,logP,ghT,JSON.stringify(done,null,2),'update log',logSha);
          log('全部完成');
        }catch(err){log(err.message,'error');}
      });
    </script>
  </body>
</html>
